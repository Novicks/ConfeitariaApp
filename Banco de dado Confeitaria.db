CREATE TABLE usuarios (
    id_usuario INTEGER PRIMARY KEY AUTOINCREMENT,
    nome TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    senha_hash TEXT NOT NULL,
    telefone TEXT,
    cpf TEXT UNIQUE,
    data_cadastro TEXT DEFAULT CURRENT_TIMESTAMP,
    ativo INTEGER DEFAULT 1
);

CREATE INDEX idx_usuarios_email ON usuarios(email);

CREATE TABLE enderecos_cliente (
    id_endereco INTEGER PRIMARY KEY AUTOINCREMENT,
    id_usuario INTEGER NOT NULL,
    nome_endereco TEXT NOT NULL,
    cep TEXT NOT NULL,
    rua TEXT NOT NULL,
    numero TEXT NOT NULL,
    complemento TEXT,
    bairro TEXT NOT NULL,
    cidade TEXT NOT NULL,
    estado TEXT NOT NULL,
    endereco_principal INTEGER DEFAULT 0,
    FOREIGN KEY(id_usuario) REFERENCES usuarios(id_usuario) ON DELETE CASCADE
);
 CREATE TABLE categorias_produto (
    id_categoria INTEGER PRIMARY KEY AUTOINCREMENT,
    nome TEXT NOT NULL,
    descricao TEXT
);
CREATE TABLE produtos (
    id_produto INTEGER PRIMARY KEY AUTOINCREMENT,
    id_categoria INTEGER,
    nome TEXT NOT NULL,
    descricao TEXT,
    preco REAL NOT NULL,
    foto TEXT,
    ativo INTEGER DEFAULT 1,
    FOREIGN KEY(id_categoria) REFERENCES categorias_produto(id_categoria)
);
CREATE TABLE carrinho (
    id_carrinho INTEGER PRIMARY KEY AUTOINCREMENT,
    id_usuario INTEGER NOT NULL,
    id_produto INTEGER NOT NULL,
    quantidade INTEGER NOT NULL DEFAULT 1,
    observacoes TEXT,
    data_adicao TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(id_usuario) REFERENCES usuarios(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY(id_produto) REFERENCES produtos(id_produto) ON DELETE CASCADE
);
 CREATE TABLE pedidos (
    id_pedido INTEGER PRIMARY KEY AUTOINCREMENT,
    id_usuario INTEGER NOT NULL,
    id_endereco_entrega INTEGER,
    subtotal REAL NOT NULL,
    taxa_entrega REAL DEFAULT 0,
    valor_total REAL NOT NULL,
    forma_pagamento TEXT NOT NULL CHECK(forma_pagamento IN ('credito','debito','pix','dinheiro')),
    status TEXT NOT NULL DEFAULT 'aguardando',
    observacoes TEXT,
    data_pedido TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(id_usuario) REFERENCES usuarios(id_usuario),
    FOREIGN KEY(id_endereco_entrega) REFERENCES enderecos_cliente(id_endereco)
);
 CREATE TABLE itens_pedido (
    id_item_pedido INTEGER PRIMARY KEY AUTOINCREMENT,
    id_pedido INTEGER NOT NULL,
    id_produto INTEGER NOT NULL,
    quantidade INTEGER NOT NULL,
    preco_unitario REAL NOT NULL,
    subtotal_item REAL NOT NULL,
    FOREIGN KEY(id_pedido) REFERENCES pedidos(id_pedido) ON DELETE CASCADE,
    FOREIGN KEY(id_produto) REFERENCES produtos(id_produto)
);
 CREATE TABLE notificacoes (
    id_notificacao INTEGER PRIMARY KEY AUTOINCREMENT,
    id_usuario INTEGER NOT NULL,
    titulo TEXT NOT NULL,
    mensagem TEXT NOT NULL,
    lida INTEGER DEFAULT 0,
    data_envio TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(id_usuario) REFERENCES usuarios(id_usuario)
);
 CREATE TABLE grupos_personalizacao (
    id_grupo INTEGER PRIMARY KEY AUTOINCREMENT,
    nome TEXT NOT NULL,
    descricao TEXT,
    minimo_opcoes INTEGER DEFAULT 0,
    maximo_opcoes INTEGER DEFAULT 1, -- ex: só 1 sabor de massa
    obrigatorio INTEGER DEFAULT 1     -- 1 = obrigatório, 0 = opcional
);
 CREATE TABLE opcoes_personalizacao (
    id_opcao INTEGER PRIMARY KEY AUTOINCREMENT,
    id_grupo INTEGER NOT NULL,
    nome TEXT NOT NULL,
    preco_adicional REAL DEFAULT 0.00,
    FOREIGN KEY(id_grupo) REFERENCES grupos_personalizacao(id_grupo) ON DELETE CASCADE
);
 CREATE TABLE itens_pedido_personalizacao (
    id_item_personalizacao INTEGER PRIMARY KEY AUTOINCREMENT,
    id_item_pedido INTEGER NOT NULL,
    id_opcao INTEGER NOT NULL,
    nome_grupo TEXT NOT NULL,
    nome_opcao TEXT NOT NULL,
    preco_adicional REAL DEFAULT 0.00,
    FOREIGN KEY(id_item_pedido) REFERENCES itens_pedido(id_item_pedido) ON DELETE CASCADE,
    FOREIGN KEY(id_opcao) REFERENCES opcoes_personalizacao(id_opcao)
);
INSERT INTO produtos (id_categoria, nome, descricao, preco, ativo)
VALUES (1, 'Bolo Personalizado', 'Monte o seu bolo do jeito que quiser', 0, 1);